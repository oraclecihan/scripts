with manifest as ( SELECT
            mnt_id,
            mnt_createstamp,
			mnt_seq_number,
            mnt_carrier_code ,
			mnt_flight_number,
            mnt_sender,
            mnt_un_loc_loading,
            mnt_un_loc_unloading,
            mnt_loc_loading,
            mnt_loc_unloading,
            mnt_calc_departure_date,
            mnt_departure_date,
            mnt_nil_cargo_ind,
            mnt_aircraft_registration,
			replace(mnt.mnt_aircraft_registration,'-','')  as mnt_aircraft_reg_last,
            isnull((
                SELECT
                    (
                        SELECT
                            c.eu_ind
                        FROM
                            dwh_staging.lin_iso_countries c
                        WHERE
                            c.iso_code = t.apt_ulc_countrycode
                    ) eu_ind
                FROM
                    dwh_staging.lin_airports t
                WHERE
                    t.apt_iata_code = mnt.mnt_loc_loading
            ), 'N') mnt_eu_ind_origin,
            isnull((
                SELECT
                    (
                        SELECT
                            c.eu_ind
                        FROM
                            dwh_staging.lin_iso_countries c
                        WHERE
                            c.iso_code = t.apt_ulc_countrycode
                    ) eu_ind
                FROM
                    dwh_staging.lin_airports t
                WHERE
                    t.apt_iata_code = mnt.mnt_loc_unloading
            ), 'N') mnt_eu_ind_dest ,
            (
                SELECT
                    flt.flt_id
                FROM
                    dwh_staging.lin_flights            flt,
                    dwh_staging.lin_flight_manifests   fmnt
                WHERE
                    flt.flt_id = fmnt.flt_id
                    AND fmnt.mnt_id = mnt.mnt_id
                    AND fmnt.fmt_last_data_ind = 'Y'
                    AND flt.flt_last_data_ind = 'Y'
            ) as matched_flight
        FROM
            dwh_staging.lin_manifests mnt
        WHERE
            mnt_sender = 'KLM'
            AND mnt_last_data_ind = 'Y'
            AND mnt_createstamp > '2020-05-18 00:00:00.000'
    )
	select mt.mnt_id,mt.mnt_createstamp,mt.mnt_carrier_code,mt.mnt_flight_number,mt.mnt_sender, case 
			   when (len(ft.flt_aircraft_registration) = 0 and len(mt.mnt_aircraft_registration) = 0) then 'both  aircraft reg are missing'
			   when (mt.matched_flight is null ) then 'no matched ciss flight with manifest'
			   when (len(ft.flt_aircraft_registration) = 0 or ft.flt_aircraft_registration is null) then 'ciss aircraft reg missing'
			   when (len(mt.mnt_aircraft_registration) = 0 or mt.mnt_aircraft_registration is null) then 'manifest aircraft reg missing'	   
			   when (ft.flt_aircraft_registration = mt.mnt_aircraft_registration ) then 'direct matched'
			   when (ft.flt_aircraft_registration = replace(mt.mnt_aircraft_registration,'-','')) then 'matched with hyphen'
			   when (ft.flt_aircraft_registration <> replace(mt.mnt_aircraft_registration,'-','')) then 'unmatched'
            end status_aircraft_reg, replace(mt.mnt_aircraft_registration,'-','')  as mnt_aircraft_reg_last , 
	ft.flt_id, ft.flt_aircraft_registration,ft.flt_scheduled_date, ft.flt_estimated_date,
	ft.flt_src_ind_last_estimate,
	ft.flt_arr_dep_ind,
	ft.flt_airport_en_route1,	
	ft.flt_airport_en_route2,
	ft.flt_airport_en_route3,
	ft.flt_airport_en_route4
	from manifest mt
	left join dwh_staging.lin_flights ft on ft.flt_id=mt.matched_flight
WHERE
    mnt_eu_ind_origin = 'N'
    AND mnt_eu_ind_dest = 'Y'
	order by ft.flt_id asc, mt.mnt_seq_number asc
	
	
	
	select * from LIN_AWB_STATUSSEN where date_created >= to_date('01.11.2019','dd.mm.yyyy') 
and awb_number=20191612 and awb_prefix='000' and date_created < to_date('01.01.2020','dd.mm.yyyy') and type in ('DEP','RCS')

select awb_prefix,awb_number,count(*) from LIN_AWB_STATUSSEN where date_created >= to_date('01.11.2019','dd.mm.yyyy')  
and date_created < to_date('01.01.2020','dd.mm.yyyy') and type in ('DEP','RCS')
and awb_prefix <> '000'
group by awb_prefix,awb_number having count(*) > 1